!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Bos=e():t.Bos=e()}(this,(()=>(()=>{"use strict";var t={d:(e,r)=>{for(var i in r)t.o(r,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:r[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>E});var r=function(){return r=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},r.apply(this,arguments)};function i(t,e,r){var i=t.createShader(e);if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){var o="Shader compilation error: "+t.getShaderInfoLog(i);throw t.deleteShader(i),new Error(o)}return i}function o(t,e,r){var i=t.createProgram();if(t.attachShader(i,e),t.attachShader(i,r),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){var o="Program linking error: "+t.getProgramInfoLog(i);throw t.deleteProgram(i),new Error(o)}return i}function a(t,e,i,o,a){var n=r({framebuffer:null,pixels:null,minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,flip:!1,premultiply:!1},a),s=t.createTexture();return t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,s),n.flip&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),n.premultiply&&t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,o,0,t.RGBA,t.UNSIGNED_BYTE,n.pixels||null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,n.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,n.wrapT),n.framebuffer&&(t.bindFramebuffer(t.FRAMEBUFFER,n.framebuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0)),s}function n(t,e){var r,i=t.createBuffer();return r=e instanceof Array&&!(e instanceof Float32Array)?new Float32Array(e):e,t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,r||null,t.STATIC_DRAW),i}function s(t,e){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];return i.reduce((function(i,o){var a;return r(r({},i),((a={})[o]=t.getUniformLocation(e,o),a))}),{})}var u={"lowp float":"uniform1f","mediump float":"uniform1f","highp float":"uniform1f",float:"uniform1f",vec2:"uniform2f","lowp vec2":"uniform2f","mediump vec2":"uniform2f","highp vec2":"uniform2f",vec3:"uniform3f","lowp vec3":"uniform3f","mediump vec3":"uniform3f","highp vec3":"uniform3f","float[]":"uniform1fv","lowp float[]":"uniform1fv","mediump float[]":"uniform1fv","highp float[]":"uniform1fv","vec2[]":"uniform2fv","lowp vec2[]":"uniform2fv","mediump vec2[]":"uniform2fv","highp vec2[]":"uniform2fv","vec3[]":"uniform3fv","lowp vec3[]":"uniform3fv","mediump vec3[]":"uniform3fv","highp vec3[]":"uniform3fv"},h=[[-.5,-.5,"uvleft","uvbottom"],[.5,-.5,"uvright","uvbottom"],[-.5,.5,"uvleft","uvtop"],[-.5,.5,"uvleft","uvtop"],[.5,-.5,"uvright","uvbottom"],[.5,.5,"uvright","uvtop"]],f=["x","y","scalex","scaley","rot","alpha","u","v"],l=function(t,e,r,i,o){var a=o||"\n    // bos's default customizable vertex shader\n    attribute mat4 a_all;\n    varying vec2 v_uv;\n    varying float v_alpha;\n    \n    // custom varying\n    ".concat(e||"","\n    // custom uniforms\n    ").concat(r||"","\n    // end of custom variable declarations\n   \n    // time is always highp\n    uniform highp float u_time;\n    uniform vec2 u_aspect;\n\n    void main() {\n        vec2 c = a_all[0].xy;\n        vec2 scale = a_all[0].ba;\n        float rot = a_all[1][0];\n        float alpha = a_all[1][1];\n        vec2 uv = a_all[1].ba;\n        vec2 pos = a_all[2].xy;\n\n        float custom0 = a_all[2][2];\n        float custom1 = a_all[2][3];\n        float custom2 = a_all[3][0];\n        float custom3 = a_all[3][1];\n        float custom4 = a_all[3][2];\n        float custom5 = a_all[3][3];\n\n        // custom animation code goes here\n        ").concat(t||"","\n        // end of custom animation code\n\n        // rotate\n        float _sin = sin(rot);\n        float _cos = cos(rot);\n        mat2 rotationMatrix = mat2(_cos, _sin, -_sin, _cos);\n        pos = rotationMatrix * pos;\n\n        // scale and translate\n        pos = pos * scale + c;\n\n        // apply aspect ratio\n        pos *= u_aspect;\n\n        v_uv = uv;\n        v_alpha = alpha;\n        gl_Position = vec4(pos, 0.0, 1.0);\n    }\n\n");return!o&&i&&(a="precision ".concat(i," float;")+a),a},c=function(t,e){var r=t||"\n    // bos's default fragment shader\n    uniform sampler2D u_texture0;\n\n    varying vec2 v_uv;\n    varying float v_alpha;\n\n    void main() {\n        vec2 st = v_uv;\n        vec4 col = texture2D(u_texture0, st);\n        gl_FragColor = vec4(col.xyz, col.a * v_alpha);\n    }\n";return!t&&e&&(r="precision ".concat(e," float;")+r),r},m=function(){return m=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},m.apply(this,arguments)},p=function(t,e,r){if(r||2===arguments.length)for(var i,o=0,a=e.length;o<a;o++)!i&&o in e||(i||(i=Array.prototype.slice.call(e,0,o)),i[o]=e[o]);return t.concat(i||Array.prototype.slice.call(e))},v=96,d="highp",g=function(t,e){return void 0===t?e:t},_=function(){function t(t,e){var r,i;this._vertexShader=null,this._fragmentShader=null,this._program=null,this._attribute=0,this._vertexBuffer=null,this._texture=null,this._uniforms={};var o=t.gl;this.bos=t;var a=(null===(r=e.image)||void 0===r?void 0:r[0])||e.image,n=(null===(i=e.framebufferTexture)||void 0===i?void 0:i[0])||e.framebufferTexture,s=(null==a||a.naturalWidth,m({image:[],aspect:!0,framebufferTexture:[],outputFramebuffer:null,width:t.width,height:t.height,textureWidth:(null==a?void 0:a.naturalWidth)||(null==n?void 0:n.width)||(null==e?void 0:e.width)||t.width||0,textureHeight:(null==a?void 0:a.naturalHeight)||(null==n?void 0:n.height)||(null==e?void 0:e.height)||t.height||0,visible:!0,autoResize:void 0===e.height&&void 0===e.width,textureFilter:o.LINEAR,vertexAnimationCode:"",customFragmentShader:"",customVertexShader:"",customVarying:"",customUniforms:{},precision:d,uniformValues:{}},e));if((a||n)&&(!s.textureWidth||!s.textureHeight))throw new Error("Texture width or texture height not specified");for(var u in this.gl=o,this.size=1,this.length=0,this.data=new Float32Array(this.size*v),this.visible=s.visible,this.textureFilter=s.textureFilter,this.image=s.image,this.width=s.width,this.height=s.height,this.textureWidth=s.textureWidth,this.textureHeight=s.textureHeight,this.vertexAnimationCode=s.vertexAnimationCode,this.customVertexShader=s.customVertexShader,this.customFragmentShader=s.customFragmentShader,this.customVarying=s.customVarying,this.uniformValues=s.uniformValues,this.customUniformsList=Object.keys(s.customUniforms),this.outputFramebuffer=s.outputFramebuffer,this.framebufferTexture=s.framebufferTexture,this.autoResize=s.autoResize,this.aspect=s.aspect,this.precision=s.precision,this.customUniforms={},this.customArrayUniformsLengths={},s.customUniforms){this.customUniforms[u]=s.customUniforms[u].replace(/\[\d+\]/g,"[]");var h=s.customUniforms[u].split(/\[|\]/g);h[1]&&(this.customArrayUniformsLengths[u]=parseInt(h[1]))}this.dirty={compile:!0,texture:!0,vbo:!0}}return t.prototype.addSprite=function(t){return this.addSprites([t])},t.prototype.addSprites=function(t){this.modSprites(t,this.length)},t.prototype.modSprites=function(t,e){var r=this,i=t.length+e,o=!0;if(i>this.size){for(;i>this.size;)this.size+=Math.max(i,Math.min(this.size,256));var a=new Float32Array(this.size*v);a.set(this.data,0),this.data=a,o=!1}for(var n=function(i){var o=(e+i)*v,a=t[i],n=a.custom||[],u=h.flatMap((function(t){var e=a.u+("uvright"===t[2]?a.w:0)||0,i=a.v+("uvbottom"===t[3]?a.h:0)||0,o=g(a.scaley,1),s=g(a.scalex,a.w/a.h*o||o);return[a.x||0,a.y||0,s,o,a.rot||0,g(a.alpha,1),e/r.textureWidth,1-i/r.textureHeight,t[0]||0,t[1]||0,n[0]||0,n[1]||0,n[2]||0,n[3]||0,n[4]||0,n[5]||0]}));s.data.set(u,o)},s=this,u=0;u<t.length;u++)n(u);o?(this.dirty.vboStart="number"==typeof this.dirty.vboStart?Math.min(this.dirty.vboStart,e):e,this.dirty.vboEnd="number"==typeof this.dirty.vboEnd?Math.max(this.dirty.vboEnd,i):i):this.dirty.vbo=!0,this.length=i},t.prototype.patchSprite=function(t,e){for(var r=t.custom||[],i=0;i<6;i++){for(var o=e*v+16*i,a=0;a<6;a++)void 0!==t[f[a]]&&(this.data[o+a]=t[f[a]]);if(void 0!==t.u){var n=t.u+(("uvright"===h[i][2]?t.w:0)||0);this.data[o+6]=n/this.textureWidth}if(void 0!==t.v){var s=t.v+(("uvbottom"===h[i][3]?t.h:0)||0);this.data[o+7]=1-s/this.textureHeight}for(a=0;a<6;a++)void 0!==r[a]&&(this.data[o+10+a]=r[a])}this.dirty.vboStart="number"==typeof this.dirty.vboStart?Math.min(this.dirty.vboStart,e):e,this.dirty.vboEnd="number"==typeof this.dirty.vboEnd?Math.max(this.dirty.vboEnd,e+1):e+1},t.prototype.removeSprites=function(t,e){void 0===e&&(e=1),this.data.copyWithin(t*v,(t+e)*v),this.data.fill(0,(this.length-e)*v,e*v),this.dirty.vbo=!0,this.length-=e},t.prototype.nullSprite=function(t,e){void 0===e&&(e=1),this.data.fill(0,t*v,e*v),this.dirty.vboStart="number"==typeof this.dirty.vboStart?Math.min(this.dirty.vboStart,t):t,this.dirty.vboEnd="number"==typeof this.dirty.vboEnd?Math.max(this.dirty.vboEnd,t+e):t+e},t.prototype.readSpriteData=function(t){for(var e={},r=t*v+0,i=0;i<6;i++)e[f[i]]=this.data[r+i];return e},t.prototype.setUniforms=function(t){this.uniformValues=m(m({},this.uniformValues),t)},t.prototype.setUniformsGL=function(t){var e;for(var r in t)if(this._uniforms[r],this._uniforms[r]){if(!this.customUniformsList.includes(r))throw new Error("'".concat(r,"' not found in layer's uniforms list"));var i=u[this.customUniforms[r]];if(!this.gl[i])throw new Error("'".concat(r,"' has unrecognized type '").concat(this.customUniforms[r],"'"));"object"!=typeof t[r]||this.customArrayUniformsLengths[r]?this.gl[i](this._uniforms[r],t[r]):(e=this.gl)[i].apply(e,p([this._uniforms[r]],t[r],!1))}},t.prototype.resize=function(t,e){this.width=t,this.height=e},t.prototype.compile=function(){var t=this,e=this.gl,r=this.customUniformsList.map((function(e){var r=t.customUniforms[e],i=t.customArrayUniformsLengths[e];if(i){var o=r.split("[");return"\nuniform ".concat(o[0]," ").concat(e,"[").concat(i).concat(o[1],";")}return"\nuniform ".concat(r," ").concat(e,";")})).join("");"function"==typeof this.customVertexShader?this._vertexShader=i(e,e.VERTEX_SHADER,this.customVertexShader(l(this.vertexAnimationCode,this.customVarying,r,this.precision||d,""))):this._vertexShader=i(e,e.VERTEX_SHADER,l(this.vertexAnimationCode,this.customVarying,r,this.precision||d,this.customVertexShader)),"function"==typeof this.customFragmentShader?this._fragmentShader=i(e,e.FRAGMENT_SHADER,this.customFragmentShader(c("",this.precision||d))):this._fragmentShader=i(e,e.FRAGMENT_SHADER,c(this.customFragmentShader||"",this.precision||d)),this._program=o(e,this._vertexShader,this._fragmentShader),this._attribute=e.getAttribLocation(this._program,"a_all"),this._uniforms=s.apply(void 0,p([e,this._program,"u_time","u_texture0","u_texture1","u_texture2","u_texture3","u_texture4","u_texture5","u_texture6","u_texture7","u_aspect"],this.customUniformsList,!1)),this.dirty.compile=!1},t.prototype.createvbo=function(){this._vertexBuffer=n(this.gl,this.data),this.dirty.vbo=!1,this.dirty.vboStart=void 0,this.dirty.vboEnd=void 0},t.prototype.createTexture=function(){this._texture||(this._texture=[]);for(var t=Array.isArray(this.image)?this.image:[this.image],e=0;e<t.length;e++)this.updateImage(e);this.dirty.texture=!1},t.prototype.render=function(t){this.dirty.compile&&this.compile(),(this.dirty.vbo||this.dirty.vboStart||this.dirty.vboEnd)&&this.createvbo(),this.dirty.texture&&this.createTexture();var e=this.gl;e.useProgram(this._program),e.bindBuffer(e.ARRAY_BUFFER,this._vertexBuffer);for(var r=0;r<4;r++)e.enableVertexAttribArray(this._attribute+r),e.vertexAttribPointer(this._attribute+r,4,e.FLOAT,!1,64,16*r);for(var i=0;i<this._texture.length;i++)e.activeTexture(e["TEXTURE".concat(i)]),e.bindTexture(e.TEXTURE_2D,this._texture[i]),e.uniform1i(this._uniforms["u_texture".concat(i)],i);if(Array.isArray(this.framebufferTexture))for(var o=0;o<this.framebufferTexture.length;o++)e.activeTexture(e["TEXTURE".concat(i+o)]),e.bindTexture(e.TEXTURE_2D,this.framebufferTexture[o].texture),e.uniform1i(this._uniforms["u_texture".concat(i+o)],i+o);else e.activeTexture(e["TEXTURE".concat(i)]),e.bindTexture(e.TEXTURE_2D,this.framebufferTexture.texture),e.uniform1i(this._uniforms["u_texture".concat(i)],i);e.uniform1f(this._uniforms.u_time,t||0),this.uniformValues&&this.setUniformsGL(this.uniformValues),"number"==typeof this.aspect?e.uniform2f(this._uniforms.u_aspect,this.aspect,1):this.aspect?e.uniform2f(this._uniforms.u_aspect,this.height/this.width,1):e.uniform2f(this._uniforms.u_aspect,1,1),e.bindFramebuffer(e.FRAMEBUFFER,this.outputFramebuffer),e.viewport(0,0,this.width,this.height),e.drawArrays(e.TRIANGLES,0,6*this.length)},t.prototype.updateImage=function(t){void 0===t&&(t=0),this._texture||(this._texture=[]),this._texture[t]&&this.gl.deleteTexture(this._texture[t]);var e=Array.isArray(this.image)?this.image[t]:this.image;this._texture[t]=a(this.gl,this.gl.TEXTURE0,this.textureWidth,this.textureHeight,{pixels:e,minFilter:this.textureFilter,magFilter:this.textureFilter,flip:!0,premultiply:!0})},t}(),x=function(){return x=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},x.apply(this,arguments)},y=function(){function t(t,e){var r=t.gl;this.gl=r;var i=x({image:null,textureWidth:t.width,textureHeight:t.height,textureFilter:r.LINEAR},e);this.framebuffer=r.createFramebuffer(),this.texture=a(r,r.TEXTURE0,i.textureWidth,i.textureHeight,{pixels:i.image,minFilter:i.textureFilter,magFilter:i.textureFilter,wrapS:r.CLAMP_TO_EDGE,wrapT:r.CLAMP_TO_EDGE}),r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.texture,0),r.bindFramebuffer(r.FRAMEBUFFER,null),this.width=i.textureWidth,this.height=i.textureHeight}return t.prototype.resize=function(t,e){var r=this.gl;r.bindTexture(r.TEXTURE_2D,this.texture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t,e,0,r.RGBA,r.UNSIGNED_BYTE,null),r.bindTexture(r.TEXTURE_2D,null)},t.prototype.free=function(){var t=this.gl;t.deleteFramebuffer(this.framebuffer),t.deleteTexture(this.texture)},t}(),b=function(){return b=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},b.apply(this,arguments)};const E=function(){function t(t,e,r,i){b({},i),this.gl=t,this.width=e,this.height=r,this.layers=[],t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}return t.prototype.addLayer=function(t){var e=new _(this,t);return this.layers.push(e),e},t.prototype.render=function(t){this.gl;for(var e=0;e<this.layers.length;e++)this.layers[e].visible&&this.layers[e].render(t)},t.prototype.resize=function(t,e){this.width=t,this.height=e;for(var r=0;r<this.layers.length;r++)this.layers[r].autoResize&&this.layers[r].resize(t,e)},t.prototype.canvasXtoGl=function(t,e){return(t/this.width*2-1)/(e||1)},t.prototype.canvasYtoGl=function(t){return 1-t/this.height*2},t.createProgram=o,t.createShader=i,t.createTexture=a,t.createVertexBuffer=n,t.getUniformLocations=s,t.FramebufferTexture=y,t.Layer=_,t}();return e.default})()));